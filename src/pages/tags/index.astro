---
// src/pages/tags/index.astro
import { SITE } from "@config";
import Layout from "@layouts/Layout.astro";
import Main from "@layouts/Main.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import { supabase } from "../../lib/supabase";

// Fetch all published posts to get tags
const { data: posts, error } = await supabase
  .from("posts")
  .select("tags")
  .eq("published", true);

if (error) {
  console.error("Error fetching tags:", error);
}

// Count occurrences of each tag
const tagCounts = (posts || []).reduce((acc, post) => {
  if (post.tags) {
    post.tags.forEach((tag: string) => {
      acc[tag] = (acc[tag] || 0) + 1;
    });
  }
  return acc;
}, {} as Record<string, number>);

// Convert to array and sort by count
const sortedTags = Object.entries(tagCounts)
  .sort(([, a], [, b]) => b - a)
  .map(([tag, count]) => ({ tag, count }));
---

<Layout title={`Tags | ${SITE.title}`}>
  <Header activeNav="tags" />
  <Main pageTitle="Tags" pageDesc="All tags used in posts">
    <ul class="gap-4">
      {
        sortedTags.map(({ tag, count }) => (
          <li class="inline-block">
            <a
              href={`/tags/${tag}`}
              class="mr-4 mt-4 flex items-center justify-center"
            >
              <span class="inline-block rounded-lg bg-skin-card px-3 py-1 text-skin-base hover:bg-skin-card-muted">
                {tag}
              </span>
              <span class="ml-2 text-sm text-gray-500">({count})</span>
            </a>
          </li>
        ))
      }
    </ul>

    {
      sortedTags.length === 0 && (
        <p class="text-center text-gray-500">No tags found</p>
      )
    }
  </Main>
  <Footer />
</Layout>