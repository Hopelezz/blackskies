---
// src/pages/admin/dashboard.astro
import AdminLayout from "../../components/admin/AdminLayout.astro";
import { supabase } from "../../lib/supabase";
import DashboardStats from "../../components/admin/DashboardStats.astro";
import PostsTable from "../../components/admin/PostsTable.astro";

import { checkAuth } from "../../utils/middleware";

const session = await checkAuth(Astro);

const { data: posts } = await supabase
  .from("posts")
  .select("*")
  .order("created_at", { ascending: false })
  .limit(5);

// Fetch the user's profile data including Role
const { data: profile, error: profileError } = session
  ? await supabase
      .from("profile")
      .select(
        `
        id,
        user_id,
        username,
        full_name,
        email,
        role,
        bio,
        created_at,
        updated_at
      `
      )
      .eq("user_id", session.data.session.user.id)
      .single()
  : { data: null, error: null };

if (profileError) {
  console.error("Error fetching profile:", profileError.message);
}


---

<AdminLayout title="Dashboard" session={session}>
  <div class="mb-8">
    <h1 class="mb-2 text-2xl font-bold">
      Welcome, {profile?.full_name || "User"} ({profile?.role.charAt(0).toUpperCase() + profile?.role.slice(1)})
    </h1>
    <p class="text-gray-600">Manage your content from here</p>
  </div>

  <DashboardStats session={session} />

  <div class="mt-8">
    <div class="mb-4 flex items-center justify-between">
      <h2 class="text-xl font-bold">Recent Posts</h2>
      <a
        href="/admin/new"
        class="rounded-lg bg-blue-500 px-4 py-2 text-white transition-colors hover:bg-blue-600"
      >
        Create New Post
      </a>
    </div>
    <PostsTable posts={posts ?? []} />
  </div>
</AdminLayout>
